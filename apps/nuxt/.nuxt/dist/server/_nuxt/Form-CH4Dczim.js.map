{"version":3,"file":"Form-CH4Dczim.js","sources":["../../../../app/components/base/form/FormItem.vue","../../../../app/components/base/form/Form.vue"],"sourcesContent":["<script setup lang=\"tsx\">import { ref as _ref, computed as _computed } from 'vue';\n\nimport {inject, onMounted, ref, useSlots} from 'vue'\n\nconst props = defineProps({\n  prop: String,\n  label: String,\n})\n\nconst value = ref('')\nlet error = _ref('')\n\n// 拿到 form 的 model 和注册函数\nconst formModel = inject<ref>('formModel')\nconst registerField = inject<Function>('registerField')\nconst formRules = inject('formRules', {})\n\nconst myRules = _computed(() => {\n  return formRules?.[props.prop] || []\n})\n\n// 校验函数\nconst validate = (rules, isBlur = false) => {\n  error.value = ''\n  const val = formModel.value[props.prop]\n  //为空并且是非主动触发检验的情况下，不检验\n  if (isBlur && val.trim() === '') {\n    return true\n  }\n  for (const rule of rules) {\n    if (rule.required && (!val || !val.toString().trim())) {\n      error.value = rule.message\n      return false\n    }\n    if (rule.max && val && val.toString().length > rule.max) {\n      error.value = rule.message\n      return false\n    }\n    if (rule.min && val && val.toString().length < rule.min) {\n      error.value = rule.message\n      return false\n    }\n    if (rule.max && val && val.toString().length > rule.max) {\n      error.value = rule.message\n      return false\n    }\n    if (rule.validator) {\n      try {\n        rule.validator(rule, val)\n      } catch (e) {\n        error.value = e.message\n        return false\n      }\n    }\n  }\n  return true\n}\n\n// 自动触发 blur 校验\nfunction handleBlur() {\n  const blurRules = myRules.value.filter((r) => r.trigger === 'blur')\n  if (blurRules.length) validate(blurRules, true)\n}\n\nfunction handChange() {\n  error.value = ''\n}\n\n// 注册到 Form\nonMounted(() => {\n  registerField && registerField({prop: props.prop, modelValue: value, validate})\n})\n\nlet slot = useSlots()\n\n\nfunction patchVNode(vnode, patchFn) {\n  if (!vnode) return vnode\n\n  // 如果当前节点就是我们要找的 BaseInput\n  if (vnode.type && vnode.type.name) {\n    return patchFn(vnode)\n  }\n\n  // 如果有子节点，则递归修改\n  if (Array.isArray(vnode.children)) {\n    vnode.children = vnode.children.map(child => patchVNode(child, patchFn))\n  }\n\n  return vnode\n}\n\n\ndefineRender(() => {\n  let DefaultNode: any = slot.default()[0]\n\n  // 对 DefaultNode 深度查找 BaseInput 并加上 onBlur / error\n  DefaultNode = patchVNode(DefaultNode, vnode => {\n    return {\n      ...vnode,\n      props: {\n        ...vnode.props,\n        error: !!error.value,\n        onBlur: handleBlur,\n        onChange: handChange\n      },\n    }\n  })\n\n  return <div class=\"form-item   flex gap-space\">\n    {props.label &&\n      <label class=\"w-20 flex items-start mt-1 justify-end\">\n        {myRules.value.length ? <span class=\"form-error\">*</span> : null} {props.label}\n      </label>}\n    <div class=\"flex-1 relative\">\n      <DefaultNode/>\n      <div class=\"form-error my-0.5 anim\" style={{opacity: error.value ? 1 : 0}}>{error.value} &nbsp;</div>\n    </div>\n  </div>\n})\n</script>\n\n<style scoped lang=\"scss\">\n.form-error {\n  color: #f56c6c;\n  font-size: 0.8rem;\n}\n</style>\n","<template>\n  <form @submit.prevent>\n    <slot/>\n  </form>\n</template>\n\n<script setup lang=\"ts\">\nimport {provide, ref, toRef} from 'vue'\nimport type {FormField, FormModel, FormRules} from './types'\n\ninterface Field {\n  prop: string\n  modelValue: any\n  validate: (rules: any[]) => boolean\n}\n\nconst props = defineProps({\n  model: Object as () => FormModel,\n  rules: Object as () => FormRules\n})\n\nconst fields = ref<Field[]>([])\n\nconst registerField = (field: Field) => {\n  fields.value.push(field)\n}\n\n// 校验整个表单\nfunction validate(cb) {\n  let valid = true\n  fields.value.forEach(f => {\n    const fieldRules = props.rules?.[f.prop] || []\n    const res = f.validate(fieldRules)\n    if (!res) valid = false\n  })\n  cb(valid)\n}\n\n// 校验指定字段\nfunction validateField(fieldName: string, cb?: (valid: boolean) => void): boolean {\n  const field = fields.value.find(f => f.prop === fieldName)\n  if (field) {\n    const fieldRules = props.rules?.[fieldName] || []\n    const valid = field.validate(fieldRules)\n    if (cb) cb(valid)\n    return valid\n  }\n  if (cb) cb(true)\n  return true\n}\n\nprovide('registerField', registerField)\nprovide('formModel', toRef(props, 'model'))\nprovide('formValidate', validate)\nprovide('formRules', props.rules)\n\ndefineExpose({validate, validateField})\n</script>\n"],"names":["props","__props","ref","error","_ref","formModel","inject","formRules","myRules","_computed","prop","validate","rules","isBlur","value","val","trim","rule","required","toString","message","max","length","min","validator","e","handleBlur","blurRules","filter","r","trigger","handChange","slot","useSlots","patchVNode","vnode","patchFn","type","name","Array","isArray","children","map","child","DefaultNode","default","onBlur","onChange","_createVNode","label","_createTextVNode","opacity"],"mappings":"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"}