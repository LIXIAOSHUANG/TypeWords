{"version":3,"file":"export-JdQPRQb6.js","sources":["../../../../app/hooks/export.ts"],"sourcesContent":["import { loadJsLib, shakeCommonDict } from '@/utils'\nimport {\n  APP_NAME,\n  APP_VERSION,\n  EXPORT_DATA_KEY,\n  LIB_JS_URL,\n  LOCAL_FILE_KEY,\n  SAVE_DICT_KEY,\n  SAVE_SETTING_KEY,\n} from '@/config/env'\nimport { get } from 'idb-keyval'\nimport saveAs from 'file-saver'\nimport dayjs from 'dayjs'\nimport Toast from '@/components/base/toast/Toast'\nimport { useBaseStore } from '@/stores/base'\nimport { useSettingStore } from '@/stores/setting'\nimport { ref } from 'vue'\nimport { PRACTICE_ARTICLE_CACHE, PRACTICE_WORD_CACHE } from '@/utils/cache'\n\nexport function useExport() {\n  const store = useBaseStore()\n  const settingStore = useSettingStore()\n\n  let loading = ref(false)\n\n  async function exportData(\n    notice = '导出成功！',\n    fileName = `${APP_NAME}-User-Data-${dayjs().format('YYYY-MM-DD HH-mm-ss')}.zip`\n  ) {\n    if (loading.value) return\n    loading.value = true\n    try {\n      const JSZip = await loadJsLib('JSZip', LIB_JS_URL.JSZIP)\n      let data = {\n        version: EXPORT_DATA_KEY.version,\n        val: {\n          setting: {\n            version: SAVE_SETTING_KEY.version,\n            val: settingStore.$state,\n          },\n          dict: {\n            version: SAVE_DICT_KEY.version,\n            val: shakeCommonDict(store.$state),\n          },\n          [PRACTICE_WORD_CACHE.key]: {\n            version: PRACTICE_WORD_CACHE.version,\n            val: {},\n          },\n          [PRACTICE_ARTICLE_CACHE.key]: {\n            version: PRACTICE_ARTICLE_CACHE.version,\n            val: {},\n          },\n          [APP_VERSION.key]: -1,\n        },\n      }\n      let d = localStorage.getItem(PRACTICE_WORD_CACHE.key)\n      if (d) {\n        try {\n          data.val[PRACTICE_WORD_CACHE.key] = JSON.parse(d)\n        } catch (e) {}\n      }\n      let d1 = localStorage.getItem(PRACTICE_ARTICLE_CACHE.key)\n      if (d1) {\n        try {\n          data.val[PRACTICE_ARTICLE_CACHE.key] = JSON.parse(d1)\n        } catch (e) {}\n      }\n      let r = await get(APP_VERSION.key)\n      data.val[APP_VERSION.key] = r\n\n      const zip = new JSZip()\n      zip.file('data.json', JSON.stringify(data))\n\n      const mp3 = zip.folder('mp3')\n      const allRecords = await get(LOCAL_FILE_KEY)\n      for (const rec of allRecords ?? []) {\n        mp3.file(rec.id + '.mp3', rec.file)\n      }\n      let content = await zip.generateAsync({ type: 'blob' })\n      saveAs(content, fileName)\n      notice && Toast.success(notice)\n      return content\n    } catch (e: any) {\n      Toast.error(e?.message || e || '导出失败')\n    } finally {\n      loading.value = false\n    }\n  }\n\n  return {\n    loading,\n    exportData,\n  }\n}\n"],"names":[],"mappings":";;;;;;;AAmBO,SAAS,YAAY;AAC1B,QAAM,QAAQ,aAAA;AACd,QAAM,eAAe,gBAAA;AAErB,MAAI,UAAU,IAAI,KAAK;AAEvB,iBAAe,WACb,SAAS,SACT,WAAW,GAAG,QAAQ,cAAc,MAAA,EAAQ,OAAO,qBAAqB,CAAC,QACzE;AACA,QAAI,QAAQ,MAAO;AACnB,YAAQ,QAAQ;AAChB,QAAI;AACF,YAAM,QAAQ,MAAM,UAAU,SAAS,WAAW,KAAK;AACvD,UAAI,OAAO;AAAA,QACT,SAAS,gBAAgB;AAAA,QACzB,KAAK;AAAA,UACH,SAAS;AAAA,YACP,SAAS,iBAAiB;AAAA,YAC1B,KAAK,aAAa;AAAA,UAAA;AAAA,UAEpB,MAAM;AAAA,YACJ,SAAS,cAAc;AAAA,YACvB,KAAK,gBAAgB,MAAM,MAAM;AAAA,UAAA;AAAA,UAEnC,CAAC,oBAAoB,GAAG,GAAG;AAAA,YACzB,SAAS,oBAAoB;AAAA,YAC7B,KAAK,CAAA;AAAA,UAAC;AAAA,UAER,CAAC,uBAAuB,GAAG,GAAG;AAAA,YAC5B,SAAS,uBAAuB;AAAA,YAChC,KAAK,CAAA;AAAA,UAAC;AAAA,UAER,CAAC,YAAY,GAAG,GAAG;AAAA,QAAA;AAAA,MACrB;AAEF,UAAI,IAAI,aAAa,QAAQ,oBAAoB,GAAG;AACpD,UAAI,GAAG;AACL,YAAI;AACF,eAAK,IAAI,oBAAoB,GAAG,IAAI,KAAK,MAAM,CAAC;AAAA,QAClD,SAAS,GAAG;AAAA,QAAC;AAAA,MACf;AACA,UAAI,KAAK,aAAa,QAAQ,uBAAuB,GAAG;AACxD,UAAI,IAAI;AACN,YAAI;AACF,eAAK,IAAI,uBAAuB,GAAG,IAAI,KAAK,MAAM,EAAE;AAAA,QACtD,SAAS,GAAG;AAAA,QAAC;AAAA,MACf;AACA,UAAI,IAAI,MAAM,IAAI,YAAY,GAAG;AACjC,WAAK,IAAI,YAAY,GAAG,IAAI;AAE5B,YAAM,MAAM,IAAI,MAAA;AAChB,UAAI,KAAK,aAAa,KAAK,UAAU,IAAI,CAAC;AAE1C,YAAM,MAAM,IAAI,OAAO,KAAK;AAC5B,YAAM,aAAa,MAAM,IAAI,cAAc;AAC3C,iBAAW,OAAO,cAAc,IAAI;AAClC,YAAI,KAAK,IAAI,KAAK,QAAQ,IAAI,IAAI;AAAA,MACpC;AACA,UAAI,UAAU,MAAM,IAAI,cAAc,EAAE,MAAM,QAAQ;AACtD,aAAO,SAAS,QAAQ;AACxB,gBAAU,MAAM,QAAQ,MAAM;AAC9B,aAAO;AAAA,IACT,SAAS,GAAQ;AACf,YAAM,MAAM,GAAG,WAAW,KAAK,MAAM;AAAA,IACvC,UAAA;AACE,cAAQ,QAAQ;AAAA,IAClB;AAAA,EACF;AAEA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,EAAA;AAEJ;"}