{"file":"MigrateDialog-DTKAmkmx.js","mappings":";;;;;;;;;;;;;;;AAOA,UAAM,SAAS,qBAAqB,MAAM,OAAO,sBAAgC,CAAC;AAElF,UAAM,QAAQA,SAAW,SAAA,YAAC;AAE1B,UAAM,OAAO;AAEb,mBAAe,qBAAqB;AAClC,aAAO,IAAI,QAAQ,OAAO,SAAS,WAAW;AAE5C,YAAI,aAAa;AAEjB,YAAI,WAAW;AAAA,UACb;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QAAA;AAGF,YAAI,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,QAAA;AAEF,cAAM,aAAa,SAAO,KAAK,GAAG,UAAU,iBAAiB,UAAU,sBAAsB;AAE7F,YAAI,CAAC,WAAY,QAAO,OAAO,yBAAyB;AAExD,uBAAe,UAAU,OAAO;AAC9B,cAAI,MAAM,WAAW,WAAY;AACjC,cAAI,MAAM,MAAM,SAAS,mBAAoB;AAC7C,gBAAM,UAAU,MAAM,KAAK;AAC3B,kBAAQ,IAAI,WAAW,OAAO;AAG9B,kBAAQ,QAAQ,CAAA,QAAO;AACrB,gBAAI,QAAQ,aAAa,GAAG,MAAM,QAAW;AAC3C,2BAAa,QAAQ,KAAK,QAAQ,aAAa,GAAG,CAAC;AAAA,YACrD;AAAA,UACF,CAAC;AAGD,mBAAS,OAAO,UAAU;AACxB,gBAAI,QAAQ,UAAU,GAAG,MAAM,QAAW;AACxC,oBAAM,IAAI,KAAK,QAAQ,UAAU,GAAG,CAAC;AAAA,YACvC;AAAA,UACF;AAEA,UAAA,SAAO,oBAAoB,WAAW,SAAS;AAC/C,kBAAQ,IAAI;AAAA,QACd;AAEA,QAAA,SAAO,iBAAiB,WAAW,SAAS;AAG9B,oBAWR;AAAA,MACR,CAAC;AAAA,IACH;AAEA,mBAAe,WAAW;AACxB,UAAI;AACF,cAAM,mBAAA;AACN,qBAAa,QAAQ,gCAAgC,GAAG;AACxD,gBAAQ,IAAI,MAAM;AAClB,cAAM,QAAQ,MAAM;AACpB,cAAM,QAAQ;AACd,aAAK,IAAI;AAAA,MACX,SAAS,GAAG;AACV,cAAM,MAAM,UAAU,CAAC;AACvB,gBAAQ,MAAM,QAAQ,CAAC;AAAA,MACzB;AAAA,IACF;;;oBAImB,MAAA;AAAA,2CAAA,MAAK,QAAA;AAAA,QACb,QAAQ;AAAA,QACR,MAAI;AAAA,QACJ,mBAAmBC,KAAAA,GAAE,cAAA;AAAA,QACrB,OAAOA,KAAAA,GAAE,cAAA;AAAA,MAAA;yBAJlB,CAgBS,GAAAC,QAAAC,UAAA,aAAA;;0IATAF,KAAAA,GAAE,oBAAA,CAAA,wDAAsDG,MAAA,MAAA,CAAM,8CAG9DH,KAAAA,GAAE,2BAAA,CAAA;;;cALTI,YAUM,OAAA,EAVD,OAAM,gCAA4B;AAAA,gBACrCA,YAEK,MAAA,EAFD,OAAM,gCAA4B;AAAA,kBACjCJ,gBAAAA,gBAAAA,KAAAA,4BAA2B,KAAC,CAAA;AAAA,kBAAAI,YAA4C,QAAA,EAAtC,OAAM,aAAA,mBAAgBD,MAAA,MAAA,CAAM,GAAA,CAAA;AAAA,gBAAA;gBAEnEC,YAEK,4BADAJ,KAAAA,GAAE,2BAAA,CAAA,GAAA,CAAA;AAAA,gBAEPI,YAEM,aAFD,8CAEL;AAAA,cAAA;;;;;;;;;;;;;;;;","names":["_useModel","$t","_push","_parent","_unref","_createVNode"],"sources":["../../../../app/components/MigrateDialog.vue"],"sourcesContent":["<script setup lang=\"ts\">\n\nimport Toast from \"@/components/base/toast/Toast.ts\";\nimport { Origin } from \"@/config/env.ts\";\nimport { set } from 'idb-keyval';\nimport { defineAsyncComponent } from \"vue\";\n\nconst Dialog = defineAsyncComponent(() => import('@/components/dialog/Dialog.vue'))\n\nconst model = defineModel()\n\nconst emit = defineEmits([\"ok\"])\n\nasync function migrateFromOldSite() {\n  return new Promise(async (resolve, reject) => {\n    // 旧域名地址\n    var OLD_ORIGIN = 'https://2study.top';\n    // 需要迁移的 IndexedDB key\n    var IDB_KEYS = [\n      'type-words-app-version',\n      'typing-word-dict',\n      'typing-word-setting',\n      'typing-word-files'\n    ];\n    // 需要迁移的 localStorage key\n    var LS_KEYS = [\n      'PracticeSaveWord',\n      'PracticeSaveArticle'\n    ];\n    const migrateWin = window.open(`${OLD_ORIGIN}/migrate.html`, '_blank', 'width=400,height=400');\n\n    if (!migrateWin) return reject('弹窗被阻止，请在网址输入栏最右边，点击允许弹窗');\n\n    async function onMessage(event) {\n      if (event.origin !== OLD_ORIGIN) return;\n      if (event.data?.type !== 'MIGRATION_RESULT') return;\n      const payload = event.data.payload;\n      console.log('payload', payload);\n\n      // 写入 localStorage\n      LS_KEYS.forEach(key => {\n        if (payload.localStorage[key] !== undefined) {\n          localStorage.setItem(key, payload.localStorage[key]);\n        }\n      });\n\n      // 写入 IndexedDB\n      for (let key of IDB_KEYS) {\n        if (payload.indexedDB[key] !== undefined) {\n          await set(key, payload.indexedDB[key]);\n        }\n      }\n\n      window.removeEventListener('message', onMessage);\n      resolve(true);\n    }\n\n    window.addEventListener('message', onMessage);\n\n    // 等窗口加载完毕后发请求\n    const timer = setInterval(() => {\n      if (!migrateWin || migrateWin.closed) {\n        clearInterval(timer);\n        reject('迁移窗口已关闭');\n      } else {\n        try {\n          migrateWin.postMessage({type: 'REQUEST_MIGRATION_DATA'}, OLD_ORIGIN);\n        } catch (e) {\n          // 跨域安全错误忽略，等窗口完全加载后再试\n        }\n      }\n    }, 100);\n  });\n}\n\nasync function transfer() {\n  try {\n    await migrateFromOldSite();\n    localStorage.setItem('__migrated_from_2study_top__', '1');\n    console.log('迁移完成');\n    Toast.success('迁移完成')\n    model.value = false\n    emit('ok')\n  } catch (e) {\n    Toast.error('迁移失败：' + e)\n    console.error('迁移失败', e);\n  }\n}\n</script>\n\n<template>\n  <Dialog v-model=\"model\"\n          :footer=\"true\"\n          @ok=\"transfer\"\n          :confirmButtonText=\"$t('migrate_data')\"\n          :title=\"$t('migrate_data')\">\n    <div class=\"px-4 flex-col center w-100\">\n      <h2 class=\"text-align-center text-2xl\">\n        {{ $t('migrate_new_domain') }} <span class=\"color-blue\">{{ Origin }}</span>\n      </h2>\n      <h3>\n        {{ $t('migrate_old_domain_notice') }}\n      </h3>\n      <div>\n        如果您不想此时迁移，关闭弹窗后，您可随时在“设置” -> “数据管理” 里面再次进行\n      </div>\n    </div>\n  </Dialog>\n</template>\n\n<style scoped lang=\"scss\">\n\n</style>\n"],"version":3}