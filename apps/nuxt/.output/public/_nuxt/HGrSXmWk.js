import{u as $,t as k,c as R,i as ee,a as B,b as te}from"./CA9m3cH7.js";import{z as L,D as Q,bk as X,H as f,j as ae,l as oe}from"./CL2Zm6Gn.js";const ne=ee?window:void 0,re={json:"application/json",text:"text/plain"};function Y(r){return r&&R(r,"immediate","refetch","initialData","timeout","beforeFetch","afterFetch","onFetchError","fetch","updateDataOnError")}function S(r){return typeof Headers<"u"&&r instanceof Headers?Object.fromEntries(r.entries()):r}function se(r,...l){var G,M;const N=typeof AbortController=="function";let g={},o={immediate:!0,refetch:!1,timeout:0,updateDataOnError:!1};const a={method:"GET",type:"text",payload:void 0};l.length>0&&(Y(l[0])?o={...o,...l[0]}:g=l[0]),l.length>1&&Y(l[1])&&(o={...o,...l[1]});const{fetch:U=(M=(G=ne)==null?void 0:G.fetch)!=null?M:globalThis?.fetch,initialData:z,timeout:I}=o,J=B(),V=B(),W=B(),w=f(!1),y=f(!1),D=f(!1),j=f(null),x=f(null),C=f(null),E=f(z||null),Z=ae(()=>N&&y.value);let v,m;const P=e=>{N&&(v?.abort(e),v=new AbortController,v.signal.onabort=()=>D.value=!0,g={...g,signal:v.signal})},A=e=>{y.value=e,w.value=!e};I&&(m=$(P,I,{immediate:!1}));let H=0;const d=async(e=!1)=>{var n,p;P(),A(!0),C.value=null,j.value=null,D.value=!1,H+=1;const F=H,s={method:a.method,headers:{}},h=Q(a.payload);if(h){const t=S(s.headers),T=Object.getPrototypeOf(h);!a.payloadType&&h&&(T===Object.prototype||Array.isArray(T))&&!(h instanceof FormData)&&(a.payloadType="json"),a.payloadType&&(t["Content-Type"]=(n=re[a.payloadType])!=null?n:a.payloadType),s.body=a.payloadType==="json"?JSON.stringify(h):h}let K=!1;const u={url:Q(r),options:{...s,...g},cancel:()=>{K=!0}};if(o.beforeFetch&&Object.assign(u,await o.beforeFetch(u)),K||!U)return A(!1),Promise.resolve(null);let c=null;return m&&m.start(),U(u.url,{...s,...u.options,headers:{...S(s.headers),...S((p=u.options)==null?void 0:p.headers)}}).then(async t=>{if(x.value=t,j.value=t.status,c=await t.clone()[a.type](),!t.ok)throw E.value=z||null,new Error(t.statusText);return o.afterFetch&&({data:c}=await o.afterFetch({data:c,response:t,context:u,execute:d})),E.value=c,J.trigger(t),t}).catch(async t=>{let T=t.message||t.name;if(o.onFetchError&&({error:T,data:c}=await o.onFetchError({data:c,error:t,response:x.value,context:u,execute:d})),C.value=T,o.updateDataOnError&&(E.value=c),V.trigger(t),e)throw t;return null}).finally(()=>{F===H&&A(!1),m&&m.stop(),W.trigger(null)})},q=k(o.refetch);L([q,k(r)],([e])=>e&&d(),{deep:!0});const O={isFinished:X(w),isFetching:X(y),statusCode:j,response:x,error:C,data:E,canAbort:Z,aborted:D,abort:P,execute:d,onFetchResponse:J.on,onFetchError:V.on,onFetchFinally:W.on,get:i("GET"),put:i("PUT"),post:i("POST"),delete:i("DELETE"),patch:i("PATCH"),head:i("HEAD"),options:i("OPTIONS"),json:b("json"),text:b("text"),blob:b("blob"),arrayBuffer:b("arrayBuffer"),formData:b("formData")};function i(e){return(n,p)=>{if(!y.value)return a.method=e,a.payload=n,a.payloadType=p,oe(a.payload)&&L([q,k(a.payload)],([F])=>F&&d(),{deep:!0}),{...O,then(F,s){return _().then(F,s)}}}}function _(){return new Promise((e,n)=>{te(w).toBe(!0).then(()=>e(O)).catch(n)})}function b(e){return()=>{if(!y.value)return a.type=e,{...O,then(n,p){return _().then(n,p)}}}}return o.immediate&&Promise.resolve().then(()=>d()),{...O,then(e,n){return _().then(e,n)}}}export{se as u};
